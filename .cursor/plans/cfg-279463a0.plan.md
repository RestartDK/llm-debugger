<!-- 279463a0-c286-40db-b40b-c0eff6b447d6 c36868dc-e847-47bf-9da9-dfb707c34351 -->
# CFG Debugger UI Design Plan

### 1. Layout and information architecture

- Define a **two-pane layout**: a **collapsible left sidebar** for inspectors, and a **main canvas** for the control flow graph (CFG) using React Flow.
- The **main canvas** shows all CFG nodes, each with:
  - Block name header
  - Code snippet body
  - Status pill (Pending / Failed / Succeeded) in the top-right
- The **left sidebar** contains two VS Code–style collapsible sections:
  - `RUNTIME STATE INSPECTOR`
  - `PROBLEMS`
- There is always exactly one **active node/execution step** that drives what the left panel shows.

### 2. Left panel design

#### 2.1 Collapsible sidebar behavior

- The entire left sidebar can be **collapsed/expanded** via a narrow handle (e.g. `◀` / `▶`).
- Inside, `RUNTIME STATE INSPECTOR` and `PROBLEMS` are **independent collapsible sections** with headers and carets (like VS Code panels).

#### 2.2 Runtime State Inspector (table view)

- Data model roughly mirrors the backend `intermediate_states` list:
  - Each entry: `{ block_id, code, before, after }` where `before`/`after` are maps of variable names to values.
- UI structure:
  - Section header: `RUNTIME STATE INSPECTOR [˅]`.
  - Just below the header, a single-line label: `Block: <currentBlockName> (active)` reflecting the currently active node/step.
  - Main content is a **table where each row is one execution step** (not just one row per block):
```text
┌───────────────────────────────────────────────────────────────┐
│ RUNTIME STATE INSPECTOR                             [˅]      │
├───────────────────────────────────────────────────────────────┤
│ Block: Block C (active)                                     │
│                                                              │
│ ┌────┬─────────────┬──────────────┬──────────────┐           │
│ │ #  │ Block/Code  │ Before       │ After        │           │
│ ├────┼─────────────┼──────────────┼──────────────┤           │
│ │✅1  │ A: cnt=0... │ s='LLM'      │ cnt=0        │           │
│ │✅2  │ B: for c... │ cnt=0        │ cnt=0,c='L'  │           │
│ │❌3  │ C: cnt+=2   │ cnt=0,c='L'  │ cnt=2,c='L'  │  ← active │
│ │✅4  │ B: for c... │ cnt=2        │ cnt=2,c='L'  │   row     │
│ │❌5  │ C: cnt+=2   │ cnt=2,c='L'  │ cnt=4,c='L'  │           │
│ │…   │ …           │ …            │ …            │           │
│ └────┴─────────────┴──────────────┴──────────────┘           │
└───────────────────────────────────────────────────────────────┘
```

- Columns:
  - `#`: step index and tiny status icon (✅/❌/⏳).
  - `Block/Code`: small label with block name (`A`, `Block 1`, etc.) plus a truncated snippet from `code`.
  - `Before`: compact representation of key variables before the block (e.g. `cnt=0, c='L'`).
  - `After`: compact representation of key variables after the block (e.g. `cnt=2, c='L'`).
- Behavior:
  - Table is scrollable when there are many steps.
  - The **active row** is highlighted and corresponds to the active node/execution step.
  - Changed values between `Before` and `After` can be highlighted (bold/colored).
  - Clicking a row sets that row’s block/step as active and syncs the graph.

#### 2.3 Problems section (separate title)

- Section header: `PROBLEMS [˅]` (visually distinct from the inspector header).
- Items list failures and suspicious steps, e.g.:
```text
PROBLEMS [˅]
├ ❌ Block C @ step 3 – cnt increments by 2, should be 1
└ ❌ Block C @ step 5 – cnt increments by 2, should be 1
```

- Each item includes:
  - Block name
  - Optional step index
  - Short LLM-generated error reason.
- Clicking an item:
  - Sets the corresponding node/step as active.
  - Scrolls/selects the matching row in `RUNTIME STATE INSPECTOR`.
  - Focuses/highlights the corresponding node on the graph.

### 3. CFG node card design

- Each React Flow node uses a custom `CfgNode` card with:
  - **Header**: block name left-aligned; **status pill** (Pending/Failed/Succeeded) on the top-right.
  - **Body**: primary code snippet for that block (one or a few lines, ellipsis if long).
  - Optional **footer**: a tiny summary of state changes (e.g. `Δ: cnt +2, c stays 'L'`).
- Visual language for statuses:
  - **Pending**: neutral border/background, spinner or hollow circle icon.
  - **Succeeded**: success-colored border/accent, check icon.
  - **Failed**: error-colored border/accent, x/alert icon; optional subtle red tint.
- Failed nodes show a small error icon/button that can open a popover/drawer with the full LLM error explanation.

### 4. Active node semantics

- The **active node** is the block + specific execution step the user is currently inspecting.
- Ways to change the active node:
  - **Click a node** on the graph → select a default or latest step for that block in the inspector and highlight that row.
  - **Click a row** in `RUNTIME STATE INSPECTOR` → make that row’s block/step active and center/highlight the corresponding node in the graph.
  - **Click a problem** in `PROBLEMS` → jump to the associated failed step and node.
- When the active node changes:
  - `Block: …` label in the inspector updates.
  - The corresponding row in the inspector table is highlighted.
  - Matching problem entries (if any) are highlighted.
  - The matching node card in the graph gets a strong active styling (thicker border/glow).

### 5. Metadata and hover behavior

- **Node hover**:
  - Shows a tooltip near the node with metadata: file name, line start, line end, optionally function name.
  - Hover does **not** change the active node; it’s purely informational.
- **Node click**:
  - Sets the node (and a representative step) as active and syncs the inspector and problems.

### 6. Sidebar collapsed state

- When collapsed, the left sidebar becomes a slim vertical bar with a toggle (e.g. `▶`).
- The main canvas expands to full width; detailed before/after and problems lists are hidden.
- Nodes still show status pills and hover tooltips for basic debugging context.

### 7. Mapping to shadcn + React Flow

- Use shadcn components conceptually as follows:
  - `Collapsible` / `Accordion` for `RUNTIME STATE INSPECTOR` and `PROBLEMS` sections.
  - `Table` for the runtime state step list (with custom row highlighting for active step and status icons).
  - `Badge` or `Chip`-style component for status pills on node cards.
  - `Tooltip` for hover metadata on nodes.
  - `Popover` or `Sheet`/`Dialog` for detailed LLM error explanations on failed nodes.
- In React Flow:
  - Define a custom node type `CfgNode` that renders the card with props: `blockId`, `blockName`, `codeSnippet`, `status`, `file`, `lineStart`, `lineEnd`, etc.
  - Wire selection and hover callbacks so they update global React state: `activeNodeId`, `activeStepId`, and `intermediateStates`.

### 8. ASCII layouts for key states

#### 8.1 Default view (left open, active node synchronized)

```text
┌──────────────────────── LEFT PANEL ───────────────────────┬──────────── MAIN CANVAS (React Flow) ────────────┐
│ ◀                                                        │                                                  │
│ RUNTIME STATE INSPECTOR                          [˅]     │          ┌───────────────┐                       │
│ Block: Block C (active)                                 │          │ Block A       │                       │
│                                                          │          │ code...       │   status: ✅          │
│ ┌────┬─────────────┬──────────────┬──────────────┐       │          └───────▲───────┘                       │
│ │ #  │ Block/Code  │ Before       │ After        │       │                  │                               │
│ ├────┼─────────────┼──────────────┼──────────────┤       │          ┌───────┴───────┐                       │
│ │✅1  │ A: cnt=0... │ s='LLM'      │ cnt=0        │       │          │ Block B       │   (active node)      │
│ │✅2  │ B: for c... │ cnt=0       │ cnt=0,c='L'  │       │          │ for c in s... │   status: ✅ + glow   │
│ │❌3  │ C: cnt+=2   │ cnt=0,c='L' │ cnt=2,c='L'  │ <── active row   └───────▲───────┘                       │
│ │✅4  │ B: for c... │ cnt=2       │ cnt=2,c='L'  │       │                  │                               │
│ │❌5  │ C: cnt+=2   │ cnt=2,c='L' │ cnt=4,c='L'  │       │          ┌───────┴───────┐                       │
│ │…   │ …           │ …            │ …            │       │          │ Block C       │                       │
│ └────┴─────────────┴──────────────┴──────────────┘       │          │ cnt += 2      │   status: ❌          │
│                                                          │          └───────────────┘                       │
│ PROBLEMS                                        [˅]      │                                                  │
│ ├ ❌ Block C @ step 3 – cnt increments by 2, should be 1 │                                                  │
│ └ ❌ Block C @ step 5 – cnt increments by 2, should be 1 │                                                  │
└───────────────────────────────────────────────────────────┴──────────────────────────────────────────────────┘
```

#### 8.2 Hover over node (metadata tooltip)

```text
          ┌───────────────┐
          │ Block C       │   status: ❌
          │ cnt += 2      │
          └───────────────┘
                  ▲
                  │ hover
                  ▼
          ┌───────────────────────────────┐
          │ file:   counter.py           │
          │ lines:  23–27                │
          │ func:   count_chars          │
          └───────────────────────────────┘
```

#### 8.3 Failed node focus (error details)

```text
┌──────────────────────── LEFT PANEL ───────────────────────┬──────────── MAIN CANVAS ─────────────────────────┐
│ RUNTIME STATE INSPECTOR                          [˅]     │                                                  │
│ Block: Block C (active, failed)                         │          ┌───────────────┐                       │
│                                                          │          │ Block C       │                       │
│ ┌────┬─────────────┬──────────────┬──────────────┐       │          │ cnt += 2      │   status: ❌          │
│ │ #  │ Block/Code  │ Before       │ After        │       │          ├───────────────┤                       │
│ ├────┼─────────────┼──────────────┼──────────────┤       │          │ ! LLM error…  │ (error icon/button)  │
│ │✅1  │ A: …        │ …            │ …            │       │          └───────────────┘                       │
│ │✅2  │ B: …        │ …            │ …            │       │                 │                                │
│ │❌3  │ C: cnt+=2   │ cnt=0,c=L    │ cnt=2,c=L    │ <── active row   ┌─────────────────────────────┐        │
│ │…   │ …           │ …            │ …            │       │          │ Error detail (popover):     │        │
│ └────┴─────────────┴──────────────┴──────────────┘       │          │ "cnt increments by 2, ..." │        │
│                                                          │          └─────────────────────────────┘        │
│ PROBLEMS                                        [˅]      │                                                  │
│ ▶ ❌ Block C @ step 3 – cnt increments by 2, should be 1 │ (selected problem, matched to row 3 & node)     │
└───────────────────────────────────────────────────────────┴──────────────────────────────────────────────────┘
```

#### 8.4 Sidebar collapsed

```text
┌─┬────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│▶│                                      MAIN CANVAS (full width)                                            │
│ │                                                                                                          │
│ │    ┌───────────────┐                    ┌───────────────┐                                               │
│ │    │ Block A       │ status: ✅         │ Block B       │ status: ✅                                     │
│ │    └───────▲───────┘                    └───────▲───────┘                                               │
│ │            │                                     │                                                      │
│ │      ┌─────┴─────┐                       ┌───────┴───────┐                                               │
│ │      │ Block C    │ status: ❌           │ Block D       │ status: ⏳ (pending)                          │
│ │      └────────────┘                       └──────────────┘                                              │
│ │                                                                                                          │
└─┴──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 9. Implementation-focused todos

- The existing todos remain valid and now refer to this refined design for the left panel and active node behavior. t

### To-dos

- [ ] Lock down two-pane layout and define what data appears in the left panel versus the main CFG canvas.
- [ ] Design the Runtime State Inspector and Problems sections, including how they collapse and what fields they show.
- [ ] Design the CFG node card, including header (block name + status), snippet area, and runtime output summary/footer.
- [ ] Define visual treatment for pending, succeeded, and failed states, and how failures show LLM error messages.
- [ ] Specify behavior for hover, selection, and how the left panel reacts to node selection and errors.
- [ ] Create ASCII wireframes for default, hover, failed-node, and collapsed-sidebar states.